<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KaiGPT â€¢ SAFI â€” Knowing.AI (Official Demo)</title>
<meta name="description" content="KaiGPT powered by SAFI â€” Knowing.AI â€” Grand Egyptian Museum assistant. Bilingual: Egyptian Arabic & English."/>
<style>
  :root{
    --bg:#09090b;
    --panel:#0f1114;
    --muted:#9aa4ad;
    --text:#eef3f6;
    --accent:#00d1c1; /* teal accent */
    --accent-2:#6b4bff; /* purple depth */
    --gold:#b88b2f; /* subtle gold for tiny highlights if needed */
    --glass: rgba(255,255,255,0.02);
    --radius:14px;
    --max-width:980px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system;background:linear-gradient(180deg,var(--bg),#050507);color:var(--text);-webkit-font-smoothing:antialiased}
  a{color:var(--accent)}
  /* layout */
  .root{display:flex;height:100vh;padding:18px;gap:18px}
  .sidebar{
    width:320px;background:linear-gradient(180deg,var(--panel),#0b0d10);border-radius:var(--radius);
    padding:20px;display:flex;flex-direction:column;gap:16px;border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:68px;height:68px;border-radius:12px;background:linear-gradient(135deg,var(--accent-2),var(--accent));
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#021;font-size:20px;box-shadow:0 8px 24px rgba(0,0,0,0.6)
  }
  .brand h1{margin:0;font-size:18px}
  .brand .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .slogan{font-weight:700;color:var(--accent);margin-top:8px}
  .powered{color:var(--muted);font-size:12px;margin-top:10px}

  .quick{display:flex;flex-direction:column;gap:10px}
  .quick button{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:10px;border-radius:10px;text-align:left;cursor:pointer}
  .quick button:hover{color:var(--text);background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12))}

  .sidebar .footer{margin-top:auto;color:var(--muted);font-size:13px}

  /* main */
  .main{flex:1;display:flex;flex-direction:column;gap:12px}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:6px 12px}
  .title{font-size:20px;font-weight:800}
  .tag{background:var(--glass);padding:6px 10px;border-radius:10px;color:var(--muted);font-weight:700}

  .container{flex:1;display:flex;gap:18px;align-items:stretch}
  .chat-column{flex:1;max-width:var(--max-width);margin:0 auto;display:flex;flex-direction:column;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
  .messages{flex:1;padding:26px;overflow:auto;display:flex;flex-direction:column;gap:16px;min-height:420px}
  .welcome{display:flex;gap:16px;align-items:flex-start;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
  .avatar{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;background:linear-gradient(135deg,var(--panel),#0b0c0f);border:2px solid rgba(255,255,255,0.03)}
  .welcome-text h2{margin:0 0 6px 0;font-size:20px}
  .welcome-text p{margin:0;color:var(--muted);line-height:1.6;max-width:720px}

  .msg{display:flex;gap:12px;align-items:flex-start}
  .msg.user{flex-direction:row-reverse;justify-content:flex-end}
  .bubble{padding:14px 16px;border-radius:12px;max-width:78%;line-height:1.6;white-space:pre-wrap;word-wrap:break-word}
  .msg.user .bubble{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));color:var(--text);border:1px solid rgba(255,255,255,0.02)}
  .msg.bot .bubble{background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(255,255,255,0.01));color:var(--text);border:1px solid rgba(0,0,0,0.18);box-shadow:0 6px 18px rgba(2,4,6,0.6)}
  .bubble .title-small{font-weight:700;color:var(--accent-2);font-size:13px;margin-bottom:6px}

  .composer{padding:16px 18px;border-top:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.005), transparent)}
  .composer-inner{display:flex;gap:12px;align-items:flex-end;max-width:var(--max-width);margin:0 auto}
  textarea.input{flex:1;min-height:48px;max-height:260px;resize:none;border-radius:12px;padding:12px;background:var(--panel);border:1px solid rgba(255,255,255,0.02);color:var(--text);font-size:15px;outline:none}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021;border:none;font-weight:800;box-shadow:0 8px 24px rgba(0,209,193,0.08)}

  .small-note{color:var(--muted);font-size:13px;text-align:center;margin-top:8px}

  .right-col{width:320px;display:flex;flex-direction:column;gap:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);color:var(--muted)}

  /* pyramid subtle background */
  .bg-pyramid{
    position:fixed;right:10%;top:8%;opacity:0.04;pointer-events:none;transform:scale(1.6);
  }

  @media (max-width:1100px){
    .root{padding:12px}
    .sidebar{display:none}
    .right-col{display:none}
    .chat-column{max-width:100%}
  }

  /* small UI niceties */
  .ghost-btn{background:transparent;border:1px dashed rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted)}
</style>
</head>
<body>
  <!-- subtle pyramid graphic -->
  <svg class="bg-pyramid" width="480" height="360" viewBox="0 0 480 360" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M240 10 L420 320 H60 L240 10 Z" fill="#e6e6e6"/>
  </svg>

  <div class="root" role="application">
    <aside class="sidebar" aria-label="Sidebar">
      <div>
        <div class="brand">
          <div class="logo" aria-hidden="true">KAI</div>
          <div>
            <h1>Knowing.AI</h1>
            <div class="sub">KaiGPT â€¢ SAFI â€” GEM Edition</div>
          </div>
        </div>

        <div class="slogan">Know more. Do more.</div>

        <div style="margin-top:14px;">
          <div class="card" style="margin-bottom:12px">
            <strong style="color:var(--text)">SAFI â€” Egyptian Guide</strong>
            <div style="margin-top:8px;color:var(--muted);font-size:13px">Ù…Ø±Ø´Ø¯Ø© Ø°ÙƒÙŠØ© Ø«Ù†Ø§Ø¦ÙŠØ© Ø§Ù„Ù„ØºØ© ØªØ´Ø±Ø­ Ù„Ù„Ø²ÙˆØ§Ø± ÙˆØªØ±Ø¯ Ø¨Ø¯ÙØ¡ ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ Ù…ØµØ±ÙŠ Ø£ØµÙŠÙ„.</div>
          </div>

          <div class="card">
            <div style="font-weight:700;margin-bottom:8px;color:var(--text)">Quick prompts</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn" onclick="app.sendPrompt('When will the Grand Egyptian Museum officially open?')">ğŸ› Opening date</button>
              <button class="btn" onclick="app.sendPrompt('Ø£ÙŠÙ† ÙŠÙ‚Ø¹ Ø§Ù„Ù…ØªØ­Ù Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±ØŸ')">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
              <button class="btn" onclick="app.sendPrompt('Tell me about SAFI')">ğŸ‘¸ About SAFI</button>
              <button class="btn" onclick="app.sendPrompt('What is Knowing.AI?')">ğŸš€ Knowing.AI</button>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        Â© 2025 Knowing.AI<br>
        <strong style="color:var(--accent)">Know more. Do more.</strong>
      </div>
    </aside>

    <main class="main" role="main">
      <div class="topbar">
        <div class="title">KaiGPT <span class="tag" style="margin-left:10px">GEM EDITION</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" onclick="app.reset()">Reset</button>
          <button id="voiceBtn" class="btn" onclick="app.toggleVoice()">ğŸ¤ Voice</button>
        </div>
      </div>

      <div class="container">
        <section class="chat-column" aria-label="Chat Column">
          <div class="messages" id="messages" role="log" aria-live="polite">
            <div class="welcome" id="welcome">
              <div class="avatar" aria-hidden="true">ğŸ‘¸ğŸ»</div>
              <div class="welcome-text">
                <h2>Ø£Ù†Ø§ ØµØ§ÙÙŠ â€” Ø¬Ø§Ù‡Ø²Ø© Ø£Ø¬Ø§ÙˆØ¨Ùƒ</h2>
                <p>Ø£Ù†Ø§ ØµØ§ÙÙŠØŒ Ø¬Ø§Ù‡Ø²Ø© Ø£Ø¬Ø§ÙˆØ¨Ùƒ Ø¹Ù† ÙƒÙ„ Ø­Ø§Ø¬Ø© ØªØ®Øµ Ø§Ù„Ù…ØªØ­Ù Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±. Ø¥Ø³Ø£Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ù…ØµØ±ÙŠ Ø£Ùˆ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØŒ ÙˆÙ‡Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø¨Ø³Ø±Ø¹Ø© ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ ÙˆØ¯ÙˆØ¯.</p>
              </div>
            </div>
          </div>

          <div class="composer" aria-label="Composer">
            <div class="composer-inner">
              <textarea id="input" class="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§... (Ù…Ø«Ø§Ù„: Ù…ØªÙ‰ Ø§Ù„Ø§ÙØªØªØ§Ø­ØŸ / When is the opening?)" oninput="app.onInput()" onkeydown="app.onKey(event)"></textarea>
              <div class="controls">
                <button id="mic" class="btn" onclick="app.toggleRecording()">ğŸ™</button>
                <button class="btn" onclick="app.toggleExample()">ğŸŒ</button>
                <button class="btn primary" onclick="app.send()">â¤ Send</button>
              </div>
            </div>
            <div class="small-note">SAFI â€” Knowing.AI â€¢ Bilingual assistant â€¢ Demo: client-side rule-based</div>
          </div>
        </section>

        <aside class="right-col" aria-hidden="true">
          <div class="card">
            <strong style="color:var(--text)">About Knowing.AI</strong>
            <p style="margin-top:8px;color:var(--muted)">Knowing.AI Ù…Ù†ØµØ© Ù…ØµØ±ÙŠØ© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ â€” Ø­Ù„ÙˆÙ„ Ù„Ù„Ø³ÙŠØ§Ø­Ø© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¨Ù†ÙˆÙƒ ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØµØºÙŠØ±Ø©.</p>
          </div>

          <div class="card">
            <strong style="color:var(--text)">Quick Facts</strong>
            <ul style="margin:8px 0 0 18px;color:var(--muted);padding:0;">
              <li>Opening: 1 November 2025</li>
              <li>Location: Giza, near the pyramids</li>
              <li>Artifacts: 57k+</li>
            </ul>
          </div>
        </aside>
      </div>
    </main>
  </div>

<script>
/* ========================= Knowledge base =========================
   Expanded Q&A: GEM, SAFI, Knowing.AI, Egypt highlights.
   You can extend the KNOWLEDGE array later or load JSON externally.
*/
const KNOWLEDGE = [
  { id:1, keywords:["Ù…ØªÙ‰","Ø§ÙØªØªØ§Ø­","opening","when","november","1 november","1 Ù†ÙˆÙÙ…Ø¨Ø±"], a_ar:"1 Ù†ÙˆÙÙ…Ø¨Ø± 2025.", a_en:"November 1, 2025." },
  { id:2, keywords:["Ø§ÙŠÙ†","Ø£ÙŠÙ†","Ù…ÙƒØ§Ù†","where","location","giza","Ø§Ù„Ø¬ÙŠØ²Ø©","Ø§Ù‡Ø±Ø§Ù…Ø§Øª","pyramids"], a_ar:"Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ Ù…ÙŠÙ„ Ù…Ù† Ø£Ù‡Ø±Ø§Ù…Ø§Øª Ø§Ù„Ø¬ÙŠØ²Ø©ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ù…ØµØ±.", a_en:"One mile from the Giza Pyramids, Cairo, Egypt." },
  { id:3, keywords:["Ù…Ø³Ø§Ø­Ø©","size","480000","480,000","Ù…ØªØ± Ù…Ø±Ø¨Ø¹"], a_ar:"Ø­ÙˆØ§Ù„ÙŠ 480,000 Ù…ØªØ± Ù…Ø±Ø¨Ø¹ â€” Ø£ÙƒØ¨Ø± Ù…ØªØ­Ù Ø£Ø«Ø±ÙŠ Ù…Ø®ØµØµ Ù„Ø­Ø¶Ø§Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.", a_en:"Approximately 480,000 square meters â€” the largest archaeological museum dedicated to a single civilization." },
  { id:4, keywords:["ØªÙˆØª","ØªÙˆØª Ø¹Ù†Ø®","tutankhamun","treasures","ÙƒÙ†ÙˆØ²"], a_ar:"ÙŠØ¶Ù… Ø£ÙƒØ«Ø± Ù…Ù† 100,000 Ù‚Ø·Ø¹Ø© Ø£Ø«Ø±ÙŠØ© Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ÙƒÙ†ÙˆØ² ØªÙˆØª Ø¹Ù†Ø® Ø¢Ù…ÙˆÙ†.", a_en:"It houses over 100,000 artifacts including the complete treasures of King Tutankhamun." },
  { id:5, keywords:["ØµØ§ÙÙŠ","safi","Ù…Ù† Ù‡ÙŠ ØµØ§ÙÙŠ","who is safi","about safi"], a_ar:"ØµØ§ÙÙŠ Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø´Ø¯Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ù† Knowing.AI â€” ØµÙˆØª ÙˆØ¯ÙˆØ¯ ÙˆØ¯Ø§ÙØ¦ Ù„Ù„Ø²Ø§Ø¦Ø±ÙŠÙ†.", a_en:"SAFI is the intelligent guide from Knowing.AI â€” a warm, friendly voice for visitors." },
  { id:6, keywords:["knowing.ai","knowing ai","what is knowing","Ù…Ù† Ù‡ÙŠ knowing.ai"], a_ar:"Knowing.AI Ù…Ù†ØµØ© Ù…ØµØ±ÙŠØ© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ â€” Ù…Ù‡Ù…ØªÙ‡Ø§: Know more. Do more.", a_en:"Knowing.AI is Egypt's unified AI platform â€” mission: Know more. Do more." },
  { id:7, keywords:["Ù„ØºØ§Øª","languages","language","english","arabic","Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"], a_ar:"ØµØ§ÙÙŠ ØªØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.", a_en:"SAFI supports Egyptian Arabic and English." },
  { id:8, keywords:["ÙÙ†ÙˆÙ†","history","Ø­Ø¶Ø§Ø±Ø©","ancient","pharaoh","pharaohs","Ø¹Ø¬Ø§Ø¦Ø¨","wonders"], a_ar:"Ù…ØµØ± Ø§Ø­ØªÙˆØª ØªØ§Ø±ÙŠØ®ÙŠØ§Ù‹ Ø¹Ù„Ù‰ 3 Ù…Ù† Ø¹Ø¬Ø§Ø¦Ø¨ Ø§Ù„Ø¯Ù†ÙŠØ§ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: Ø§Ù„Ù‡Ø±Ù… Ø§Ù„Ø£ÙƒØ¨Ø±ØŒ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©ØŒ ÙˆÙ…Ù†Ø§Ø±Ø© Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©.", a_en:"Historically Egypt hosted 3 of the ancient world's wonders: the Great Pyramid, the Library of Alexandria, and the Lighthouse (Pharos)." },
  { id:9, keywords:["Ø²ÙˆØ§Ø±","visitors","visiting","tourism","Ø³ÙŠØ§Ø­Ø©"], a_ar:"Ø§Ù„Ù…ØªØ­Ù Ù…ØªÙˆÙ‚Ø¹ Ø£Ù† ÙŠØ¬Ø°Ø¨ Ù…Ù„Ø§ÙŠÙŠÙ† Ø§Ù„Ø²ÙˆØ§Ø± Ø³Ù†ÙˆÙŠØ§Ù‹ ÙˆÙŠØ¹Ø²Ø² Ø§Ù„Ø³ÙŠØ§Ø­Ø© Ø§Ù„Ù…ØµØ±ÙŠØ©.", a_en:"The museum is expected to attract millions of visitors annually and boost Egyptian tourism." },
  { id:10, keywords:["tech","technology","vr","hologram","ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§","Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ"], a_ar:"ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØ­Ù ØªÙ‚Ù†ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù…Ø«Ù„ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ Ø§Ù„Ù‡ÙˆÙ„ÙˆØ¬Ø±Ø§Ù…ØŒ ÙˆØ´Ø§Ø´Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©.", a_en:"The museum uses advanced technologies like VR, holograms, and interactive touchscreens." },
  { id:11, keywords:["Ø£Ù‡Ø±Ø§Ù…Ø§Øª","pyramids","giza","khufu","Ø®ÙˆÙÙˆ"], a_ar:"Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§Øª Ù…Ù† Ø£Ø¨Ø±Ø² Ù…Ø¹Ø§Ù„Ù… Ù…ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ ÙˆØªØ·Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ­Ù Ù…Ù† Ù…ÙˆÙ‚Ø¹Ù‡ Ø§Ù„Ù‚Ø±ÙŠØ¨.", a_en:"The Pyramids are among Egypt's most iconic ancient monuments and sit near the museum." },
  { id:12, keywords:["contact","Ø§ØªØµÙ„","support","knowing.ai contact","email"], a_ar:"Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ¯Ø¹Ù…: knowing.ai.eg@outlook.com", a_en:"For support: knowing.ai.eg@outlook.com" }
];

/* ========================= Matching helpers ========================= */
function isArabic(text){ return /[\u0600-\u06FF]/.test(text); }
function normalize(s){ return (s||'').toLowerCase().replace(/[^\w\u0600-\u06FF\s]+/g,' ').replace(/\s+/g,' ').trim(); }

/* simple fuzzy similarity (token overlap + substring) */
function scoreMatch(text, entry){
  const norm = normalize(text);
  if(!norm) return 0;
  const tokens = norm.split(' ').filter(Boolean);
  let score = 0;
  // check keywords
  for(const kw of entry.keywords){
    const nk = normalize(kw);
    for(const t of tokens){
      if(t.length<2) continue;
      if(nk === t) score += 3;
      else if(nk.includes(t) || t.includes(nk)) score += 2;
      else if(nk.startsWith(t) || nk.endsWith(t)) score += 1.5;
    }
  }
  // check question text itself
  const qtxt = normalize((entry.a_ar||'') + ' ' + (entry.a_en||''));
  for(const t of tokens){
    if(qtxt.includes(t)) score += 0.6;
  }
  // boost for numeric matches (years, numbers)
  if(norm.match(/2025|1|480000|57,000|57000|5000/)) score += 1;
  return score;
}

function findBest(text){
  const candidates = [];
  for(const e of KNOWLEDGE){
    const s = scoreMatch(text,e);
    if(s>0) candidates.push({e,s});
  }
  candidates.sort((a,b)=> b.s - a.s);
  return candidates.length ? candidates[0].e : null;
}

/* ========================= App core ========================= */
const app = {
  isVoice:false,
  recognition:null,
  init(){
    this.messagesEl = document.getElementById('messages');
    this.input = document.getElementById('input');
    this.voiceBtn = document.getElementById('voiceBtn');
    this.setupSpeech();
    this.bind();
  },
  bind(){
    document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey && document.activeElement === this.input){ e.preventDefault(); this.send(); } });
  },
  setupSpeech(){
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      this.recognition = new SR();
      this.recognition.continuous = false;
      this.recognition.interimResults = false;
      this.recognition.onresult = (e)=>{ const t = e.results[0][0].transcript; this.input.value = t; };
      this.recognition.onerror = ()=>{};
    }
    // warm up voices
    if(window.speechSynthesis) window.speechSynthesis.getVoices();
  },
  toggleRecording(){
    if(!this.recognition){ alert('Speech recognition not supported in this browser.'); return; }
    try{
      if(this.recognition._running){ this.recognition.stop(); this.recognition._running=false; }
      else{ this.recognition.lang = 'ar-EG'; this.recognition.start(); this.recognition._running=true; }
    }catch(e){}
  },
  toggleVoice(){
    this.isVoice = !this.isVoice;
    this.voiceBtn.classList.toggle('active', this.isVoice);
  },
  toggleExample(){
    const sample = isArabic(this.input.value || '') ? "Tell me about SAFI" : "Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù† ØµØ§ÙÙŠ";
    this.input.value = sample;
  },
  sendPrompt(text){ this.input.value = text; this.send(); },
  send(){
    const text = this.input.value.trim();
    if(!text) return;
    this.addMessage(text,'user');
    this.input.value = '';
    this.showTyping();
    // respond
    setTimeout(()=> this.respond(text), 600);
  },
  addMessage(content, role){
    const welcome = document.getElementById('welcome'); if(welcome) welcome.remove();
    const row = document.createElement('div'); row.className = 'msg ' + (role==='user' ? 'user' : 'bot');
    const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = role==='user' ? 'Ø£Ù†Øª' : 'ğŸ‘¸ğŸ»';
    const bubble = document.createElement('div'); bubble.className = 'bubble';
    if(role==='bot'){ bubble.innerHTML = '<div class="title-small">SAFI</div>' + escapeHtml(content); }
    else bubble.innerHTML = escapeHtml(content);
    row.appendChild(avatar); row.appendChild(bubble); this.messagesEl.appendChild(row); this.scrollBottom();
  },
  showTyping(){
    this.removeTyping();
    this.typing = document.createElement('div'); this.typing.className='msg bot'; this.typing.id='typing';
    const av = document.createElement('div'); av.className='avatar'; av.textContent='ğŸ‘¸ğŸ»';
    const b = document.createElement('div'); b.className='bubble'; b.innerHTML = '<em style="color:var(--muted)">SAFI is typingâ€¦</em>';
    this.typing.appendChild(av); this.typing.appendChild(b); this.messagesEl.appendChild(this.typing); this.scrollBottom();
  },
  removeTyping(){ const t = document.getElementById('typing'); if(t) t.remove(); },
  respond(userText){
    this.removeTyping();
    const match = findBest(userText);
    const langAr = isArabic(userText);
    let reply = '';
    if(match){
      reply = langAr ? (match.a_ar || match.a_en) : (match.a_en || match.a_ar);
    } else {
      reply = langAr
        ? "Ù…Ø¹Ø°Ø±Ø©Ù‹ØŒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¯ÙŠ Ù…Ø´ Ù…ØªÙˆÙØ±Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠ. Ø¬Ø±Ø¨ ØªØ³Ø£Ù„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ø¨Ø³Ø· Ø£Ùˆ Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©."
        : "Sorry, I don't have that info right now. Try rephrasing or choose a quick prompt.";
    }
    this.addMessage(reply,'bot');
    if(this.isVoice) this.speak(reply, langAr ? 'ar-EG' : 'en-US');
  },
  speak(text, lang){
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || 'ar-EG';
    u.rate = 0.95; u.pitch = 1.02;
    const voices = window.speechSynthesis.getVoices();
    // prefer an Arabic voice for ar-EG; prefer female-like if available by checking voice.name keywords
    if(voices && voices.length){
      let v = null;
      if(lang && lang.startsWith('ar')){
        v = voices.find(x => x.lang && x.lang.startsWith('ar') && /female|woman|Anna|Hoda|Hanan|Maged|Salma|Mariam|Mona/i.test(x.name)) || voices.find(x => x.lang && x.lang.startsWith('ar'));
      } else {
        v = voices.find(x => x.lang && x.lang.startsWith('en') && /female|woman|Samantha|Emma|Zira|Karen|Alloy/i.test(x.name)) || voices.find(x => x.lang && x.lang.startsWith('en'));
      }
      if(v) u.voice = v;
    }
    window.speechSynthesis.speak(u);
  },
  scrollBottom(){ this.messagesEl.scrollTop = this.messagesEl.scrollHeight + 200; },
  reset(){ location.reload(); },
  onInput(){ const el=this.input; el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,260)+'px'; }
};

function escapeHtml(s){ return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

/* expose app */
window.app = app;
document.addEventListener('DOMContentLoaded', ()=>{ app.init(); if(window.speechSynthesis) window.speechSynthesis.getVoices(); console.log('KaiGPT â€¢ SAFI â€” Enhanced demo ready.'); });
</script>
</body>
</html>
