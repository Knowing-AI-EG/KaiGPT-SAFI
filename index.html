<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KaiGPT â€¢ SAFI â€” Knowing.AI (Grok-like dark)</title>
  <meta name="description" content="KaiGPT powered by SAFI â€” Knowing.AI â€” Grand Egyptian Museum assistant. Bilingual: Arabic (Egyptian) & English." />
  <style>
    /* ========== THEME COLORS ========== */
    :root{
      --bg:#0b0c0f;            /* deep dark */
      --panel:#0f1114;         /* panels */
      --muted:#9aa4ad;
      --text:#e7eef3;
      --accent:#00d1c1;        /* teal accent (no yellow) */
      --accent-2:#6b4bff;      /* subtle purple depth */
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --max-width:980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system;background:linear-gradient(180deg,var(--bg),#050507);color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:var(--accent)}

    /* layout */
    .root{display:flex;height:100vh;gap:18px;padding:18px}
    .sidebar{
      width:300px; background:linear-gradient(180deg,var(--panel),#0b0d10); border-radius:var(--radius);
      padding:20px; display:flex;flex-direction:column; gap:18px; min-height:calc(100vh - 36px);
      box-shadow: 0 10px 40px rgba(10,10,12,0.6); border:1px solid rgba(255,255,255,0.03)
    }

    .brand {
      display:flex; gap:14px; align-items:center;
    }
    .logo {
      width:64px; height:64px; border-radius:14px; background:linear-gradient(135deg,var(--accent-2),var(--accent)); display:flex;align-items:center;justify-content:center;
      box-shadow: 0 8px 24px rgba(11,12,14,0.6);
      font-weight:800;color:#021; font-size:22px;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:0.2px}
    .brand p{margin:0;color:var(--muted);font-size:13px}

    .slogan { margin-top:6px; font-weight:600; color:var(--accent); font-size:13px; text-align:left; }
    .powered { color:var(--muted); font-size:12px; margin-top:6px;}

    .quick { display:flex; flex-direction:column; gap:8px; margin-top:8px;}
    .quick button{ background:transparent;border:1px solid rgba(255,255,255,0.03); color:var(--muted); padding:10px;border-radius:10px; text-align:left; cursor:pointer }
    .quick button:hover{ color:var(--text); background:linear-gradient(90deg, rgba(0,0,0,0.15), rgba(255,255,255,0.01)); border-color: rgba(0,0,0,0.2) }

    .footer-meta { margin-top:auto; color:var(--muted); font-size:12px; }

    /* main area */
    .main {
      flex:1; display:flex; flex-direction:column; gap:12px; max-width:calc(100% - 320px);
    }
    .topbar {
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .top-left { display:flex; gap:12px; align-items:center;}
    .title { font-size:20px; font-weight:700; letter-spacing:0.2px;}
    .tag { background:var(--glass); padding:6px 10px; border-radius:10px; color:var(--muted); font-weight:700; font-size:12px; border:1px solid rgba(255,255,255,0.02) }

    .container {
      flex:1; display:flex; gap:18px; align-items:stretch;
    }

    /* central chat column (ChatGPT-like) */
    .chat-column { flex:1; max-width:var(--max-width); margin:0 auto; display:flex; flex-direction:column; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border-radius:14px; border:1px solid rgba(255,255,255,0.02); overflow:hidden; box-shadow: 0 8px 30px rgba(2,4,8,0.6) }

    .messages { flex:1; padding:28px; overflow:auto; display:flex; flex-direction:column; gap:18px; min-height:420px; }
    .welcome {
      display:flex; gap:16px; align-items:flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); padding:18px; border-radius:12px;
    }
    .avatar {
      width:72px; height:72px; border-radius:50%; display:flex;align-items:center;justify-content:center;font-size:36px; background: linear-gradient(135deg,var(--panel),#0b0c0f); border:2px solid rgba(255,255,255,0.03);
    }
    .welcome-text h2{ margin:0 0 8px 0; font-size:20px}
    .welcome-text p{ margin:0; color:var(--muted); line-height:1.6; max-width:720px }

    /* message bubbles */
    .msg { display:flex; gap:12px; align-items:flex-start; }
    .msg.user { flex-direction:row-reverse; justify-content:flex-end }
    .msg .bubble {
      padding:14px 16px; border-radius:12px; max-width:76%; line-height:1.6; white-space:pre-wrap; word-wrap:break-word;
    }
    .msg.user .bubble { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); color:var(--text); border:1px solid rgba(255,255,255,0.02) }
    .msg.bot .bubble { background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(255,255,255,0.01)); color:var(--text); border:1px solid rgba(0,0,0,0.2); box-shadow: 0 6px 18px rgba(2,4,6,0.6) }

    .bubble .title-small{ font-weight:700; color:var(--accent-2); font-size:13px; margin-bottom:6px }

    /* composer (input) */
    .composer { padding:16px 20px; border-top:1px solid rgba(255,255,255,0.02); background:linear-gradient(180deg, rgba(255,255,255,0.005), transparent) }
    .composer-inner { display:flex; gap:12px; align-items:flex-end; max-width:var(--max-width); margin:0 auto; }
    textarea.input {
      flex:1; min-height:48px; max-height:200px; resize:none; border-radius:10px; padding:12px; background:var(--panel); border:1px solid rgba(255,255,255,0.02); color:var(--text); font-size:15px; outline:none;
    }
    .controls { display:flex; gap:8px; align-items:center; }
    .btn {
      background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer;
    }
    .btn.primary { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#021; border:none; font-weight:700; box-shadow: 0 8px 20px rgba(0,209,193,0.12); }

    .small-note{ color:var(--muted); font-size:13px; text-align:center; margin-top:8px }

    /* right column (optional details) */
    .right-col { width:300px; display:flex; flex-direction:column; gap:12px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.02); color:var(--muted) }

    /* responsive */
    @media (max-width:1100px){
      .root{padding:12px}
      .sidebar{display:none}
      .right-col{display:none}
      .chat-column{max-width:100%}
    }
  </style>
</head>
<body>
  <div class="root">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar" aria-label="Sidebar">
      <div>
        <div class="brand">
          <div class="logo">KAI</div>
          <div>
            <h1>Knowing.AI</h1>
            <p>SAFI â€¢ KaiGPT â€” GEM Edition</p>
          </div>
        </div>

        <div class="slogan">Know more. Do more.</div>

        <div style="margin-top:14px">
          <div class="card" style="margin-bottom:12px">
            <strong style="color:var(--text)">SAFI â€” Egyptian Guide</strong>
            <div style="margin-top:8px; color:var(--muted); font-size:13px">Ù…Ø±Ø´Ø¯Ø© Ø°ÙƒÙŠØ© Ø«Ù†Ø§Ø¦ÙŠØ© Ø§Ù„Ù„ØºØ© ØªØ´Ø±Ø­ Ù„Ù„Ø²ÙˆØ§Ø± ÙˆØªØ±Ø¯ Ø¨Ø¯ÙØ¡ ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ Ù…ØµØ±ÙŠ Ø£ØµÙŠÙ„.</div>
          </div>

          <div class="card">
            <div style="font-weight:700; margin-bottom:8px; color:var(--text)">Quick prompts</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn" onclick="app.sendPrompt('When will the Grand Egyptian Museum officially open?')">ğŸ› Opening date</button>
              <button class="btn" onclick="app.sendPrompt('Ø£ÙŠÙ† ÙŠÙ‚Ø¹ Ø§Ù„Ù…ØªØ­Ù Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±ØŸ')">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
              <button class="btn" onclick="app.sendPrompt('Tell me about SAFI')">ğŸ‘¸ About SAFI</button>
              <button class="btn" onclick="app.sendPrompt('What is Knowing.AI?')">ğŸš€ Knowing.AI</button>
            </div>
          </div>
        </div>
      </div>

      <div class="footer-meta">
        Â© 2025 Knowing.AI<br>
        Know more. Do more.
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="top-left">
          <div class="title">KaiGPT</div>
          <div class="tag">GEM EDITION</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" onclick="app.reset()">Reset</button>
          <button id="voiceBtn" class="btn" onclick="app.toggleVoice()">ğŸ¤ Voice</button>
        </div>
      </div>

      <div class="container">
        <section class="chat-column" role="main" aria-label="Chat">
          <div class="messages" id="messages">
            <!-- welcome -->
            <div class="welcome" id="welcome">
              <div class="avatar">ğŸ‘¸ğŸ»</div>
              <div class="welcome-text">
                <h2>Ø£Ù†Ø§ ØµØ§ÙÙŠ â€” Ø¬Ø§Ù‡Ø²Ø© Ø£Ø¬Ø§ÙˆØ¨Ùƒ</h2>
                <p>Ø£Ù†Ø§ ØµØ§ÙÙŠØŒ Ø¬Ø§Ù‡Ø²Ø© Ø£Ø¬Ø§ÙˆØ¨Ùƒ Ø¹Ù† ÙƒÙ„ Ø­Ø§Ø¬Ø© ØªØ®Øµ Ø§Ù„Ù…ØªØ­Ù Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±. Ø¥Ø³Ø£Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ù…ØµØ±ÙŠ Ø£Ùˆ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØŒ ÙˆÙ‡Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø¨Ø³Ø±Ø¹Ø© ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ ÙˆØ¯ÙˆØ¯.</p>
              </div>
            </div>
          </div>

          <div class="composer">
            <div class="composer-inner">
              <textarea id="input" class="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§... (Ù…Ø«Ø§Ù„: Ù…ØªÙ‰ Ø§Ù„Ø§ÙØªØªØ§Ø­ØŸ / When is the opening?)" oninput="app.onInput()" onkeydown="app.onKey(event)"></textarea>
              <div class="controls">
                <button id="mic" class="btn" onclick="app.toggleRecording()">ğŸ™</button>
                <button class="btn" onclick="app.toggleExample()">ğŸŒ</button>
                <button class="btn primary" onclick="app.send()">â¤ Send</button>
              </div>
            </div>
            <div class="small-note">SAFI â€” Knowing.AI â€¢ Bilingual assistant â€¢ No backend required for this demo</div>
          </div>
        </section>

        <!-- right column: info -->
        <aside class="right-col" aria-hidden="true">
          <div class="card">
            <strong style="color:var(--text)">About Knowing.AI</strong>
            <p style="margin-top:8px;color:var(--muted)">Knowing.AI Ù‡ÙŠ Ù…Ù†ØµØ© Ù…ØµØ±ÙŠØ© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ â€” Ø­Ù„ÙˆÙ„ Ù„Ù„Ø³ÙŠØ§Ø­Ø©ØŒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ØŒ Ø§Ù„Ø¨Ù†ÙˆÙƒØŒ ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØµØºÙŠØ±Ø©.</p>
          </div>

          <div class="card">
            <strong style="color:var(--text)">Quick Facts</strong>
            <ul style="margin:8px 0 0 18px;color:var(--muted);padding:0;">
              <li>Opening: 1 November 2025</li>
              <li>Location: Giza, near the pyramids</li>
              <li>Artifacts: 57k+</li>
            </ul>
          </div>

        </aside>
      </div>
    </main>
  </div>

  <script>
    /* ======================= Knowledge base (extended) ======================= */
    const KNOWLEDGE = [
      { id:1, keywords:["Ù…ØªÙ‰","Ø§ÙØªØªØ§Ø­","opening","when","november","1 november","1 Ù†ÙˆÙÙ…Ø¨Ø±"], a_ar:"1 Ù†ÙˆÙÙ…Ø¨Ø± 2025.", a_en:"November 1, 2025." },
      { id:2, keywords:["Ø§ÙŠÙ†","Ø£ÙŠÙ†","Ù…ÙƒØ§Ù†","where","location","giza","Ø§Ù„Ø¬ÙŠØ²Ø©","Ø§Ù‡Ø±Ø§Ù…Ø§Øª","pyramids"], a_ar:"Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ Ù…ÙŠÙ„ Ù…Ù† Ø£Ù‡Ø±Ø§Ù…Ø§Øª Ø§Ù„Ø¬ÙŠØ²Ø©ØŒ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ù…ØµØ±.", a_en:"One mile from the Giza Pyramids, Cairo, Egypt." },
      { id:3, keywords:["Ù…Ø³Ø§Ø­Ø©","size","480000","480,000","Ù…ØªØ± Ù…Ø±Ø¨Ø¹"], a_ar:"Ø­ÙˆØ§Ù„ÙŠ 480,000 Ù…ØªØ± Ù…Ø±Ø¨Ø¹ â€” Ø£ÙƒØ¨Ø± Ù…ØªØ­Ù Ø£Ø«Ø±ÙŠ Ù…Ø®ØµØµ Ù„Ø­Ø¶Ø§Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.", a_en:"Approximately 480,000 square meters â€” the largest archaeological museum dedicated to a single civilization." },
      { id:4, keywords:["ØªÙˆØª","ØªÙˆØª Ø¹Ù†Ø®","tutankhamun","treasures","ÙƒÙ†ÙˆØ²"], a_ar:"ÙŠØ¶Ù… Ø£ÙƒØ«Ø± Ù…Ù† 100,000 Ù‚Ø·Ø¹Ø© Ø£Ø«Ø±ÙŠØ© Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ÙƒÙ†ÙˆØ² ØªÙˆØª Ø¹Ù†Ø® Ø¢Ù…ÙˆÙ†.", a_en:"It houses over 100,000 artifacts including the complete treasures of King Tutankhamun." },
      { id:5, keywords:["ØµØ§ÙÙŠ","safi","Ù…Ù† Ù‡ÙŠ ØµØ§ÙÙŠ","who is safi","about safi"], a_ar:"ØµØ§ÙÙŠ Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø´Ø¯Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ù† Knowing.AI â€” ØµÙˆØª ÙˆØ¯ÙˆØ¯ ÙˆØ¯Ø§ÙØ¦ Ù„Ù„Ø²Ø§Ø¦Ø±ÙŠÙ†.", a_en:"SAFI is the intelligent guide from Knowing.AI â€” a warm, friendly voice for visitors." },
      { id:6, keywords:["knowing.ai","knowing ai","what is knowing","Ù…Ù† Ù‡ÙŠ knowing.ai"], a_ar:"Knowing.AI Ù…Ù†ØµØ© Ù…ØµØ±ÙŠØ© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ â€” Ù…Ù‡Ù…ØªÙ‡Ø§: Know more. Do more.", a_en:"Knowing.AI is Egypt's unified AI platform â€” mission: Know more. Do more." },
      { id:7, keywords:["Ù„ØºØ§Øª","languages","language","english","arabic","Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"], a_ar:"ØµØ§ÙÙŠ ØªØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.", a_en:"SAFI supports Egyptian Arabic and English." },
      { id:8, keywords:["ÙÙ†ÙˆÙ†","history","Ø­Ø¶Ø§Ø±Ø©","ancient","pharaoh","pharaohs","Ø¹Ø¬Ø§Ø¦Ø¨","wonders"], a_ar:"Ù…ØµØ± Ø§Ø­ØªÙˆØª ØªØ§Ø±ÙŠØ®ÙŠØ§Ù‹ Ø¹Ù„Ù‰ 3 Ù…Ù† Ø¹Ø¬Ø§Ø¦Ø¨ Ø§Ù„Ø¯Ù†ÙŠØ§ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: Ø§Ù„Ù‡Ø±Ù… Ø§Ù„Ø£ÙƒØ¨Ø±ØŒ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©ØŒ ÙˆÙ…Ù†Ø§Ø±Ø© Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©.", a_en:"Historically Egypt hosted 3 of the ancient world's wonders: the Great Pyramid, the Library of Alexandria, and the Lighthouse (Pharos)." },
      { id:9, keywords:["Ø²ÙˆØ§Ø±","visitors","visiting","tourism","Ø³ÙŠØ§Ø­Ø©"], a_ar:"Ø§Ù„Ù…ØªØ­Ù Ù…ØªÙˆÙ‚Ø¹ Ø£Ù† ÙŠØ¬Ø°Ø¨ Ù…Ù„Ø§ÙŠÙŠÙ† Ø§Ù„Ø²ÙˆØ§Ø± Ø³Ù†ÙˆÙŠØ§Ù‹ ÙˆÙŠØ¹Ø²Ø² Ø§Ù„Ø³ÙŠØ§Ø­Ø© Ø§Ù„Ù…ØµØ±ÙŠØ©.", a_en:"The museum is expected to attract millions of visitors annually and boost Egyptian tourism." },
      { id:10, keywords:["tech","technology","vr","hologram","ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§","Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ"], a_ar:"ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØ­Ù ØªÙ‚Ù†ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù…Ø«Ù„ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ Ø§Ù„Ù‡ÙˆÙ„ÙˆØ¬Ø±Ø§Ù…ØŒ ÙˆØ´Ø§Ø´Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ©.", a_en:"The museum uses advanced technologies like VR, holograms, and interactive touchscreens." }
      // add more entries later if needed
    ];

    /* ======================= Utilities ======================= */
    function isArabic(text){ return /[\u0600-\u06FF]/.test(text); }
    function normalize(s){ return (s||'').toLowerCase().replace(/[^\w\u0600-\u06FF\s]+/g,' ').replace(/\s+/g,' ').trim(); }

    function findMatch(text){
      const n = normalize(text);
      if(!n) return null;
      const tokens = n.split(' ').filter(Boolean);
      let best=null, bestScore=0;
      for(const entry of KNOWLEDGE){
        let score=0;
        for(const kw of entry.keywords){
          const nk = normalize(kw);
          for(const t of tokens) if(t.length>1 && nk.includes(t)) score++;
        }
        if(score>bestScore){ bestScore=score; best=entry; }
      }
      return bestScore>0 ? best : null;
    }

    /* ======================= App core ======================= */
    const app = {
      isVoice:false,
      recognition:null,
      init(){
        this.messagesEl = document.getElementById('messages');
        this.input = document.getElementById('input');
        this.setupSpeech();
        this.bind();
      },

      bind(){
        document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey && document.activeElement === this.input){ e.preventDefault(); this.send(); } });
      },

      setupSpeech(){
        if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SR();
          this.recognition.continuous = false;
          this.recognition.interimResults = false;
          this.recognition.onresult = (e)=>{
            const t = e.results[0][0].transcript;
            this.input.value = t;
          };
          this.recognition.onerror = ()=>{ /* ignore */ };
        }
      },

      toggleRecording(){
        if(!this.recognition){ alert('Speech recognition not supported on this browser.'); return; }
        try{
          if(this.recognition._running){ this.recognition.stop(); this.recognition._running=false; }
          else{ this.recognition.lang = 'ar-EG'; this.recognition.start(); this.recognition._running=true; }
        }catch(e){}
      },

      toggleVoice(){
        this.isVoice = !this.isVoice;
        const btn = document.getElementById('voiceBtn');
        btn.classList.toggle('active', this.isVoice);
      },

      toggleExample(){
        const sample = isArabic(this.input.value || '') ? "Tell me about SAFI" : "Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù† ØµØ§ÙÙŠ";
        this.input.value = sample;
      },

      sendPrompt(text){
        this.input.value = text;
        this.send();
      },

      send(){
        const text = this.input.value.trim();
        if(!text) return;
        this.addMessage(text, 'user');
        this.input.value = '';
        this.scrollBottom();
        this.showTyping();
        setTimeout(()=> this.respond(text), 600);
      },

      addMessage(content, role){
        // remove welcome if present
        const welcome = document.getElementById('welcome'); if(welcome) welcome.remove();

        const row = document.createElement('div'); row.className = 'msg ' + (role==='user' ? 'user' : 'bot');
        const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = role==='user' ? 'Ø£Ù†Øª' : 'ğŸ‘¸ğŸ»';
        const bubble = document.createElement('div'); bubble.className = 'bubble';
        if(role==='bot'){ bubble.innerHTML = '<div class="title-small">SAFI</div>' + escapeHtml(content); }
        else bubble.innerHTML = escapeHtml(content);
        row.appendChild(avatar); row.appendChild(bubble); this.messagesEl.appendChild(row);
        this.scrollBottom();
      },

      showTyping(){
        // small typing indicator
        this.typing = document.createElement('div'); this.typing.className='msg bot'; this.typing.id='typing';
        const av = document.createElement('div'); av.className='avatar'; av.textContent='ğŸ‘¸ğŸ»';
        const b = document.createElement('div'); b.className='bubble'; b.innerHTML = '<em style="color:var(--muted)">SAFI is typing...</em>';
        this.typing.appendChild(av); this.typing.appendChild(b); this.messagesEl.appendChild(this.typing); this.scrollBottom();
      },

      removeTyping(){
        const t = document.getElementById('typing'); if(t) t.remove();
      },

      respond(userText){
        this.removeTyping();
        const match = findMatch(userText);
        const langAr = isArabic(userText);
        let reply = '';
        if(match){
          reply = langAr ? (match.a_ar || match.a_en) : (match.a_en || match.a_ar);
        } else {
          // improved fallback with friendly guidance
          reply = langAr
            ? "Ù…Ø¹Ø°Ø±Ø©Ù‹ØŒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¯ÙŠ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠ. Ø¬Ø±Ø¨ ØªØ³Ø£Ù„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ø¨Ø³Ø· Ø£Ùˆ Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ."
            : "Sorry, I don't have that info right now. Try asking in a different way or use one of the quick prompts.";
        }
        this.addMessage(reply, 'bot');
        if(this.isVoice) this.speak(reply, langAr ? 'ar-EG' : 'en-US');
      },

      speak(text, lang){
        if(!('speechSynthesis' in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang || 'ar-EG';
        u.rate = 0.95; u.pitch = 1.02;
        const voices = window.speechSynthesis.getVoices();
        if(voices && voices.length){
          const v = voices.find(v=> v.lang && v.lang.startsWith(lang && lang.startsWith('ar') ? 'ar' : 'en'));
          if(v) u.voice = v;
        }
        window.speechSynthesis.speak(u);
      },

      scrollBottom(){ this.messagesEl.scrollTop = this.messagesEl.scrollHeight + 200; },

      reset(){ location.reload(); },

      onInput(){ const el = this.input; el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 220) + 'px'; }
    };

    /* small helpers */
    function escapeHtml(s){ return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

    function findMatch(text){
      const n = (text||'').toLowerCase();
      if(!n.trim()) return null;
      // strict token matching boosted with numbers
      const tokens = n.split(/\s+/).filter(Boolean);
      let best=null, bestScore=0;
      for(const e of KNOWLEDGE){
        let score=0;
        for(const kw of e.keywords){
          const nk = (''+kw).toLowerCase();
          for(const t of tokens) if(t.length>1 && nk.includes(t)) score++;
        }
        if(score>bestScore){ bestScore=score; best=e; }
      }
      return bestScore>0 ? best : null;
    }

    // expose app to window
    window.app = app;

    // init
    document.addEventListener('DOMContentLoaded', ()=> {
      app.init();
      // optional: prefetch voices to avoid first-time lag
      if(window.speechSynthesis) window.speechSynthesis.getVoices();
      console.log('KaiGPT â€¢ SAFI â€” Grok-style dark demo ready.');
    });
  </script>
</body>
</html>
